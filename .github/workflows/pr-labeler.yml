name: PR Auto Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  # =====================================
  # 0. PRタイトルのConventional Commits検証
  # =====================================
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check Conventional Commits format
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const title = context.payload.pull_request.title;

            // Conventional Commits パターン
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?!?:\s.+$/;

            if (!pattern.test(title)) {
              const errorMessage = `
            **PRタイトルがConventional Commits形式ではありません**

            現在のタイトル: \`${title}\`

            ### 正しい形式
            \`\`\`
            <type>(<scope>): <description>
            \`\`\`

            ### 使用可能なtype
            | type | 説明 |
            |------|------|
            | \`feat\` | 新機能 |
            | \`fix\` | バグ修正 |
            | \`docs\` | ドキュメント |
            | \`style\` | フォーマット |
            | \`refactor\` | リファクタリング |
            | \`perf\` | パフォーマンス |
            | \`test\` | テスト |
            | \`build\` | ビルド |
            | \`ci\` | CI/CD |
            | \`chore\` | その他 |

            ### 例
            - \`feat: ユーザー認証機能を追加\`
            - \`fix(auth): ログインエラーを修正\`
            - \`docs: READMEを更新\`
            `;

              core.setFailed(errorMessage);
            } else {
              console.log(`PRタイトルは正しい形式です: ${title}`);
            }

  # =====================================
  # 1. PRタイトルからtype/ラベルを付与
  # =====================================
  type-label:
    name: Type Label
    runs-on: ubuntu-latest
    needs: validate-title
    steps:
      - name: Add type label from PR title
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const title = context.payload.pull_request.title;
            const prNumber = context.payload.pull_request.number;

            const typeMap = {
              '^feat(\\(.+\\))?!?:': 'type:feature',
              '^fix(\\(.+\\))?!?:': 'type:bug',
              '^docs(\\(.+\\))?!?:': 'type:docs',
              '^style(\\(.+\\))?!?:': 'type:style',
              '^refactor(\\(.+\\))?!?:': 'type:refactor',
              '^perf(\\(.+\\))?!?:': 'type:perf',
              '^test(\\(.+\\))?!?:': 'type:test',
              '^build(\\(.+\\))?!?:': 'type:ci',
              '^ci(\\(.+\\))?!?:': 'type:ci',
              '^chore(\\(.+\\))?!?:': 'type:chore',
            };

            let typeLabel = null;
            for (const [pattern, label] of Object.entries(typeMap)) {
              if (new RegExp(pattern, 'i').test(title)) {
                typeLabel = label;
                break;
              }
            }

            if (typeLabel) {
              const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });

              const typeLabelsToRemove = currentLabels
                .filter(l => l.name.startsWith('type:') && l.name !== typeLabel)
                .map(l => l.name);

              for (const label of typeLabelsToRemove) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: label,
                });
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: [typeLabel],
              });

              console.log(`Added label: ${typeLabel}`);
            }

  # =====================================
  # 2. 変更ファイルからarea/ラベルを付与
  # =====================================
  area-label:
    name: Area Label
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Add area labels from changed files
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

  # =====================================
  # 3. 変更行数からsize/ラベルを付与
  # =====================================
  size-label:
    name: Size Label
    runs-on: ubuntu-latest
    steps:
      - name: Add size label from changed lines
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const additions = context.payload.pull_request.additions;
            const deletions = context.payload.pull_request.deletions;
            const totalChanges = additions + deletions;

            let sizeLabel;
            if (totalChanges <= 10) {
              sizeLabel = 'size:xs';
            } else if (totalChanges <= 50) {
              sizeLabel = 'size:s';
            } else if (totalChanges <= 200) {
              sizeLabel = 'size:m';
            } else if (totalChanges <= 500) {
              sizeLabel = 'size:l';
            } else {
              sizeLabel = 'size:xl';
            }

            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const sizeLabelsToRemove = currentLabels
              .filter(l => l.name.startsWith('size:') && l.name !== sizeLabel)
              .map(l => l.name);

            for (const label of sizeLabelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: label,
              });
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [sizeLabel],
            });

            console.log(`Total changes: ${totalChanges} → ${sizeLabel}`);
