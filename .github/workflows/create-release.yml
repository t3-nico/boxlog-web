name: Create Release

# æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ - GitHub Actions UIã‹ã‚‰å®Ÿè¡Œ
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—'
        required: true
        default: 'content'
        type: choice
        options:
          - content # ãƒ–ãƒ­ã‚°ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
          - patch # ãƒã‚°ä¿®æ­£ (0.0.x)
          - minor # æ©Ÿèƒ½è¿½åŠ  (0.x.0)
          - major # ç ´å£Šçš„å¤‰æ›´ (x.0.0)
      release_title:
        description: 'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹: Blogæ›´æ–°ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼‰'
        required: true
        type: string
      release_notes:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆï¼ˆãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¯ï¼‰'
        required: false
        type: string

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get latest release version
        id: latest
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°v0.0.0ï¼‰
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’æŠ½å‡º
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT
          echo "patch=$PATCH" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: version
        run: |
          MAJOR=${{ steps.latest.outputs.major }}
          MINOR=${{ steps.latest.outputs.minor }}
          PATCH=${{ steps.latest.outputs.patch }}

          case "${{ inputs.release_type }}" in
            content)
              # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ›´æ–°ã¯ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã‚‹
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
              ;;
            patch)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
              ;;
            minor)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
              ;;
            major)
              NEW_MAJOR=$((MAJOR + 1))
              NEW_VERSION="v${NEW_MAJOR}.0.0"
              ;;
          esac

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Generate release body
        id: body
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆç”Ÿæˆ
          RELEASE_TYPE="${{ inputs.release_type }}"
          TITLE="${{ inputs.release_title }}"
          NOTES="${{ inputs.release_notes }}"
          PREV_TAG="${{ steps.latest.outputs.latest_tag }}"
          NEW_TAG="${{ steps.version.outputs.new_version }}"

          # ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ©ãƒ™ãƒ«
          case "$RELEASE_TYPE" in
            content) TYPE_LABEL="ðŸ“ Content Update" ;;
            patch)   TYPE_LABEL="ðŸ› Bug Fix" ;;
            minor)   TYPE_LABEL="âœ¨ New Feature" ;;
            major)   TYPE_LABEL="ðŸš€ Major Release" ;;
          esac

          # ãƒœãƒ‡ã‚£ã‚’æ§‹ç¯‰
          {
            echo "## $TYPE_LABEL: $TITLE"
            echo ""
            if [ -n "$NOTES" ]; then
              echo "$NOTES"
              echo ""
            fi
            echo "---"
            echo ""
            echo "**Full Changelog**: ${{ github.server_url }}/${{ github.repository }}/compare/${PREV_TAG}...${NEW_TAG}"
          } > release_body.md

          cat release_body.md

      - name: Create tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.new_version }}
          git push origin ${{ steps.version.outputs.new_version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: '${{ steps.version.outputs.new_version }} - ${{ inputs.release_title }}'
          body_path: release_body.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… Release created successfully!"
          echo "Version: ${{ steps.version.outputs.new_version }}"
          echo "Title: ${{ inputs.release_title }}"
          echo "View at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.version.outputs.new_version }}"
