# Claude 4 プロンプトエンジニアリング ベストプラクティス

> **参照元**: [Anthropic公式ドキュメント](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/claude-4-best-practices)

このドキュメントは、Claude 4モデル（Opus 4.5、Opus 4、Sonnet 4）の特性を理解し、最適な結果を得るためのガイドラインです。

---

## 🎯 目的

1. **開発者向け**: Claude Codeに指示を出す際のベストプラクティスを理解する
2. **Claude Code向け**: 開発者の指示が不明確な場合に適切な質問を投げかける
3. **相互改善**: より良いコミュニケーションでプロジェクト品質を向上させる

---

## 📋 Claude 4モデルの特性

### 従来モデルとの違い

Claude 4モデルは**より正確な指示追従**のためにトレーニングされています。

| 特性             | 従来モデル           | Claude 4モデル       |
| ---------------- | -------------------- | -------------------- |
| 指示解釈         | 意図を推測して拡張   | 指示を文字通りに実行 |
| 出力スタイル     | 詳細・冗長になりがち | 簡潔・直接的         |
| ツール呼び出し後 | 口頭で要約           | 次のアクションに直行 |

### 重要な示唆

- ❌ 「Claude 4は指示通りにしかやらない」
- ✅ 「Claude 4は指示を正確に実行するので、**明確な指示が必要**」

---

## 🔑 5つの核心原則

### 1. 明示的な指示を出す (Be Explicit)

Claude 4は明確で具体的な指示に対して最適に応答します。

```markdown
# ❌ 曖昧な指示

「ブログ記事ページを作って」

# ✅ 明示的な指示

「ブログ記事ページを作成してください。以下の要件を満たすこと:

- MDXファイルからコンテンツを取得
- next-intlで多言語対応（日本語/英語）
- OGP画像を動的生成
- 目次を自動生成」
```

**Claude Codeへの指示**: 開発者の指示が曖昧な場合は、以下のように確認を求める:

```
「ブログページについて、以下の点を確認させてください:
1. コンテンツ取得: MDXファイルから読み込みますか？
2. 多言語対応: 日本語/英語の両方に対応しますか？
3. SEO対策: どのようなメタデータを生成しますか？」
```

---

### 2. 背景と動機を説明する (Provide Context)

「なぜ」を説明すると、Claude 4はより適切に一般化できます。

```markdown
# ❌ ルールだけを伝える

「絶対にエリプシス（…）を使わないで」

# ✅ 理由と共に伝える

「レスポンスは音声合成エンジンで読み上げられるため、
エリプシス（…）は使用しないでください。
音声合成エンジンは発音方法がわからないためです。」
```

**開発者へのガイドライン**: 制約やルールを設ける際は、その理由を必ず添える。

---

### 3. 例を慎重に選ぶ (Be Vigilant with Examples)

Claude 4は提供された例の詳細に注目し、パターンを学習します。

```markdown
# ❌ 悪い例の提供（望ましくない形式を含む）

「出力は以下のような形式で:

- name: John Doe ← これはダメ
- name: 田中太郎 ← これが正しい」

# ✅ 良い例のみ提供

「出力は以下の形式で:

- name: 田中太郎
- name: 佐藤花子
- name: 鈴木一郎」
```

**重要**: 「やってはいけない例」を見せると、それを学習してしまう可能性がある。

---

### 4. 長時間推論タスクへの対応 (Long-Horizon Reasoning)

Claude 4.5は複数のコンテキストウィンドウにまたがる長期タスクに優れています。

**推奨アプローチ**:

```markdown
# 複雑なタスクの分解

「このリファクタリングを以下のステップで進めてください:

1. まず影響範囲を調査
2. 変更計画を提案
3. 承認後、段階的に実装
4. 各ステップで進捗を報告」
```

**状態追跡のヒント**:

- 進捗ファイルを作成して状態を記録
- 次のセッションで参照できる形式で残す
- 一度に全てをやろうとせず、着実に進める

---

### 5. 拡張思考の活用 (Extended Thinking)

複雑な推論タスクでは、拡張思考を有効にすることで精度が向上します。

**適切なケース**:

- 複雑なアルゴリズム設計
- 多段階の問題解決
- ツール使用後の振り返り
- アーキテクチャ決定

**不適切なケース**:

- 単純なコード修正
- 定型的なタスク
- 即座に回答できる質問

---

## 🔄 開発者とClaude Codeの相互作用

### 開発者が守るべきベストプラクティス

#### 1. 指示は具体的に

```markdown
# ❌ 避けるべき

「このコンポーネントを改善して」

# ✅ 推奨

「Headerコンポーネントについて:

- モバイルメニューのアニメーションを追加
- アクセシビリティ属性（aria-label等）を追加
- ダークモードでのコントラストを改善」
```

#### 2. 出力形式を明確に

```markdown
# ❌ 曖昧

「結果を教えて」

# ✅ 明確

「結果を以下の形式で出力してください:

## 変更したファイル

- ファイルパス: 変更内容

## 動作確認

- [ ] チェック項目1
- [ ] チェック項目2」
```

#### 3. 制約は理由と共に

```markdown
# ❌ ルールだけ

「useEffectは使わないで」

# ✅ 理由付き

「データフェッチングにuseEffectは使用しないでください。
理由: Next.js 14ではServer Componentsでのデータ取得が推奨されているためです。」
```

---

### Claude Codeが実践すべきベストプラクティス

#### 1. 曖昧な指示への対応

開発者の指示が不明確な場合、以下のテンプレートで確認:

```markdown
「ご依頼を確認させてください。以下の点が明確でないため、
作業前に確認したいと思います:

**確認事項**:

1. [具体的な質問1]
2. [具体的な質問2]

**現時点での理解**:

- [理解している内容を記述]

**想定される選択肢**:

- A案: [選択肢Aの説明]
- B案: [選択肢Bの説明]

どちらの方向で進めますか？」
```

#### 2. ベストプラクティス違反の検出

開発者の指示がベストプラクティスに反する場合:

```markdown
「ご依頼の実装方法について、一点確認させてください。

**現在のご依頼**:
[依頼内容]

**懸念事項**:
[公式ドキュメント/ベストプラクティス]では、
[推奨される方法]が推奨されています。

**理由**:
[なぜその方法が推奨されるか]

**提案**:
[代替案の提示]

このまま進めますか？それとも推奨される方法で実装しますか？」
```

#### 3. 実装前の確認チェックリスト

大きな変更を行う前に自問する:

- [ ] 開発者の意図を正しく理解しているか？
- [ ] 既存の実装パターンを確認したか？
- [ ] 公式ドキュメントの推奨に沿っているか？
- [ ] セキュリティ上の問題はないか？
- [ ] パフォーマンスへの影響は考慮したか？

---

## 🚀 エージェントコーディングのベストプラクティス

> **参照元**: [Claude Code: Best practices for agentic coding](https://www.anthropic.com/engineering/claude-code-best-practices)

### ワークフローパターン: Explore → Plan → Code → Commit

最も効果的なワークフローは以下の4ステップです：

```markdown
1. **Explore（探索）**: コードベースを調査し、影響範囲を把握
2. **Plan（計画）**: 実装戦略を策定し、承認を得る
3. **Code（実装）**: 計画に基づいてコードを書く
4. **Commit（コミット）**: 変更を記録し、進捗を報告
```

**重要**: 「探索と計画」のステップがないと、Claudeは直接コーディングに飛びつきがち。
深い思考が必要な問題では、まず調査と計画を指示することでパフォーマンスが大幅に向上。

---

### Think ツールの活用

Claudeの拡張思考モードは、特定のキーワードで制御できます：

| キーワード     | 思考予算 | 使用ケース           |
| -------------- | -------- | -------------------- |
| `think`        | 低       | 簡単な問題の確認     |
| `think hard`   | 中       | 複雑なロジックの検討 |
| `think harder` | 高       | アーキテクチャ決定   |
| `ultrathink`   | 最大     | 重大な設計判断       |

**使用例**:

```markdown
# 簡単な確認

「このコードの問題点を think して教えて」

# 複雑な問題

「このリファクタリング方針について think hard してから提案して」

# 重大な決定

「このアーキテクチャ変更について ultrathink してから最善のアプローチを提案して」
```

---

### テスト駆動開発（TDD）との組み合わせ

Claudeは**明確なターゲット**があるとき最もパフォーマンスが向上します。
TDDはエージェントコーディングと特に相性が良いです。

**推奨ワークフロー**:

```markdown
1. 開発者がテストケースを定義
2. Claudeがテストを通すコードを実装
3. テスト失敗時は自動的に修正を試行
4. 全テスト通過で完了
```

**開発者への推奨**:

```markdown
「以下のテストケースを通す実装を作成してください:

- テスト1: [期待される動作]
- テスト2: [期待される動作]
- テスト3: [エッジケース]

テストが失敗したら、原因を分析して修正してください。」
```

---

### イテレーションの重要性

Claudeの出力は**イテレーション**で大幅に改善します。

| イテレーション | 期待される品質           |
| -------------- | ------------------------ |
| 1回目          | 基本的に動作する         |
| 2回目          | エッジケース対応         |
| 3回目          | 最適化・リファクタリング |

**開発者への推奨**:

```markdown
「この実装をレビューして、以下の観点で改善してください:

1. エッジケースの処理
2. パフォーマンス
3. 可読性

改善後、もう一度自己レビューしてください。」
```

---

### 長時間セッションの状態管理

複数のコンテキストウィンドウにまたがるタスクでは、**状態の永続化**が重要です。

**推奨アプローチ**:

1. **Gitコミット**: 進捗を記述的なコミットメッセージで記録
2. **進捗ファイル**: 現在の状態と次のステップを記録
3. **リカバリー**: 問題発生時にgit revertで復帰可能

```markdown
# 進捗ファイルの例（PROGRESS.md）

## 現在の状態

- [x] ステップ1: 完了
- [x] ステップ2: 完了
- [ ] ステップ3: 進行中

## 次のアクション

- ステップ3の残りの実装
- テストの追加

## ブロッカー

- なし
```

---

### フィードバックループの構築

最も効果的なフィードバックは**ルールベース**です。

**良いフィードバックの例**:

```markdown
# ❌ 曖昧なフィードバック

「このコードは良くない」

# ✅ ルールベースのフィードバック

「以下のルールに違反しています:

- ESLint: no-unused-vars（line 15）
- TypeScript: 型エラー（line 23）
- プロジェクトルール: useEffectでのfetch禁止

各違反を修正してください。」
```

**自動フィードバックの活用**:

- ESLint/Prettier: コードスタイル
- TypeScript: 型エラー
- テスト: 機能の正確性
- npm run type-check: 型チェック

---

## 📝 チェックリスト

### 開発者向けチェックリスト

指示を出す前に確認:

- [ ] **明示的**: 期待する結果を具体的に記述したか？
- [ ] **背景説明**: なぜその実装が必要か説明したか？
- [ ] **良い例のみ**: 望ましい例だけを提供したか？
- [ ] **出力形式**: 期待する出力形式を指定したか？
- [ ] **制約と理由**: 制約がある場合、理由も説明したか？

### Claude Code向けチェックリスト

実装前に確認:

- [ ] **理解確認**: 曖昧な点があれば質問したか？
- [ ] **既存確認**: 類似実装が既に存在しないか確認したか？
- [ ] **公式準拠**: 公式ドキュメントの推奨に沿っているか？
- [ ] **CLAUDE.md準拠**: プロジェクトルールに従っているか？
- [ ] **例外報告**: ベストプラクティスに反する場合、報告したか？

---

## 🔗 関連リソース

### Anthropic公式

- [Claude 4 Best Practices](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/claude-4-best-practices)
- [Claude Code Best Practices](https://www.anthropic.com/engineering/claude-code-best-practices)
- [The "think" Tool](https://www.anthropic.com/engineering/claude-think-tool)
- [Effective Harnesses for Long-Running Agents](https://www.anthropic.com/engineering/effective-harnesses-for-long-running-agents)
- [Building Agents with the Claude Agent SDK](https://www.anthropic.com/engineering/building-agents-with-the-claude-agent-sdk)
- [Prompt Engineering Interactive Tutorial](https://github.com/anthropics/prompt-eng-interactive-tutorial)
- [Chain of Thought Prompting](https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering/chain-of-thought)
- [Extended Thinking](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)

### プロジェクト内ドキュメント

- [CLAUDE.md](../../CLAUDE.md) - AI意思決定プロトコル
- [DOCUMENTATION_GUIDE.md](../DOCUMENTATION_GUIDE.md) - ドキュメントガイド
- [PERFORMANCE_GUIDE.md](../PERFORMANCE_GUIDE.md) - パフォーマンスガイド

---

**最終更新**: 2025-12-24 | **バージョン**: v1.0

---

## 📝 変更履歴

### v1.0（2025-12-24）

- 初版作成（boxlog-appから移植）
- Claude 4モデルの特性と5つの核心原則
- 開発者とClaude Codeの相互作用ガイドライン
- エージェントコーディングのベストプラクティス
